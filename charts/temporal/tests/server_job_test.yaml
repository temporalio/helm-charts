suite: test server job
templates:
  - server-job.yaml
tests:
  - it: is able to create the server job even if Values.server.enabled is false
    set:
      server:
        enabled: false
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
                  createDatabase: true
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
                  createDatabase: true
    asserts:
      - containsDocument:
          kind: Job
          apiVersion: batch/v1
  - it: includes additional init containers
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
                  createDatabase: true
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
                  createDatabase: true
      admintools:
        additionalInitContainers:
          - name: my-init-container
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: my-init-container
  - it: includes additional volumes
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
                  createDatabase: true
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
                  createDatabase: true
      admintools:
        additionalVolumes:
          - name: my-volume
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].name
          value: my-volume
  - it: includes additional volume mounts
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
                  createDatabase: true
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
                  createDatabase: true
      admintools:
        additionalVolumeMounts:
          - name: my-volume
    asserts:
      - equal:
          path: spec.template.spec.initContainers[*].volumeMounts[0].name
          value: my-volume
  - it: includes resource limits and requests on initContainers
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
                  createDatabase: true
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
                  createDatabase: true
      schema:
        resources:
          requests:
            cpu: 12
            memory: 12Gi
          limits:
            cpu: 16
            memory: 16Gi
    asserts:
      - equal:
          path: spec.template.spec.initContainers[*].resources.requests.cpu
          value: 12
      - equal:
          path: spec.template.spec.initContainers[*].resources.requests.memory
          value: 12Gi
      - equal:
          path: spec.template.spec.initContainers[*].resources.limits.cpu
          value: 16
      - equal:
          path: spec.template.spec.initContainers[*].resources.limits.memory
          value: 16Gi

