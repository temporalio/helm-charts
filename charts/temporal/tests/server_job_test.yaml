suite: test server job
templates:
  - server-job.yaml
tests:
  - it: is able to create the server job even if Values.server.enabled is false
    set:
      server:
        enabled: false
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
    asserts:
      - containsDocument:
          kind: Job
          apiVersion: batch/v1
  - it: includes additional init containers
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
      admintools:
        additionalInitContainers:
          - name: my-init-container
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: my-init-container
  - it: includes additional environment variables
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
          namespaces:
            create: true
      admintools:
        additionalEnv:
          - name: MY_ENV_VAR
            value: my-value
        additionalEnvSecretName: env-secret
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name=="create-default-namespace")].env[?(@.name=="MY_ENV_VAR")].value
          value: my-value
      - equal:
          path: spec.template.spec.initContainers[?(@.name=="create-default-namespace")].envFrom[0].secretRef.name
          value: env-secret
  - it: includes additional volumes
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
      admintools:
        additionalVolumes:
          - name: my-volume
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].name
          value: my-volume
  - it: includes additional volume mounts
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
      admintools:
        additionalVolumeMounts:
          - name: my-volume
    asserts:
      - equal:
          path: spec.template.spec.initContainers[*].volumeMounts[0].name
          value: my-volume
  - it: includes resource limits and requests on initContainers
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
      schema:
        resources:
          requests:
            cpu: 12
            memory: 12Gi
          limits:
            cpu: 16
            memory: 16Gi
    asserts:
      - equal:
          path: spec.template.spec.initContainers[*].resources.requests.cpu
          value: 12
      - equal:
          path: spec.template.spec.initContainers[*].resources.requests.memory
          value: 12Gi
      - equal:
          path: spec.template.spec.initContainers[*].resources.limits.cpu
          value: 16
      - equal:
          path: spec.template.spec.initContainers[*].resources.limits.memory
          value: 16Gi
  - it: includes custom annotations and labels for pod and job
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-persistence:3306"
                  databaseName: temporal
              visibility:
                sql:
                  pluginName: mysql8
                  connectAddr: "temporal-visibility:3306"
                  databaseName: temporal_visibility
      schema:
        jobAnnotations:
          custom-job-annotation: abc
        podAnnotations:
          custom-pod-annotation: def
        podLabels:
          custom-pod-label: ghi
    asserts:
      - equal:
          path: metadata.annotations.custom-job-annotation
          value: abc
      - equal:
          path: spec.template.metadata.annotations.custom-pod-annotation
          value: def
      - equal:
          path: spec.template.metadata.labels.custom-pod-label
          value: ghi
