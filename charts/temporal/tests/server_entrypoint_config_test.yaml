suite: test server entrypoint and config mounting
templates:
  - server-deployment.yaml
  - server-sprig-configmap.yaml
  - server-dockerize-configmap.yaml
  - server-entrypoint-script.yaml
tests:
  # Test entrypoint script ConfigMap creation
  - it: creates entrypoint script ConfigMap when useEntrypointScript is true
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-temporal-entrypoint-script
      - exists:
          path: data["entrypoint.sh"]

  - it: does not create entrypoint script ConfigMap when useEntrypointScript is false
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: false
    asserts:
      - hasDocuments:
          count: 0

  # Test configMapsToMount: "both" (default)
  - it: creates both ConfigMaps when configMapsToMount is both
    templates:
      - templates/server-sprig-configmap.yaml
      - templates/server-dockerize-configmap.yaml
    set:
      server:
        enabled: true
        configMapsToMount: "both"
    asserts:
      - template: templates/server-sprig-configmap.yaml
        isKind:
          of: ConfigMap
      - template: templates/server-dockerize-configmap.yaml
        isKind:
          of: ConfigMap

  - it: mounts both config volumes when configMapsToMount is both with entrypoint
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: config-dockerize
            configMap:
              name: RELEASE-NAME-temporal-dockerize-config
      - contains:
          path: spec.template.spec.volumes
          content:
            name: config-sprig
            configMap:
              name: RELEASE-NAME-temporal-sprig-config

  - it: mounts both configs to config-source paths when useEntrypointScript is true
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config-dockerize
            mountPath: /etc/temporal/config-source/dockerize
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config-sprig
            mountPath: /etc/temporal/config-source/sprig
            readOnly: true

  # Test configMapsToMount: "dockerize"
  - it: creates only dockerize ConfigMap when configMapsToMount is dockerize
    templates:
      - templates/server-sprig-configmap.yaml
      - templates/server-dockerize-configmap.yaml
    set:
      server:
        enabled: true
        configMapsToMount: "dockerize"
    asserts:
      - template: templates/server-sprig-configmap.yaml
        hasDocuments:
          count: 0
      - template: templates/server-dockerize-configmap.yaml
        isKind:
          of: ConfigMap

  - it: mounts only dockerize config volume when configMapsToMount is dockerize
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "dockerize"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: config-dockerize
            configMap:
              name: RELEASE-NAME-temporal-dockerize-config
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: config-sprig

  # Test configMapsToMount: "sprig"
  - it: creates only sprig ConfigMap when configMapsToMount is sprig
    templates:
      - templates/server-sprig-configmap.yaml
      - templates/server-dockerize-configmap.yaml
    set:
      server:
        enabled: true
        configMapsToMount: "sprig"
    asserts:
      - template: templates/server-sprig-configmap.yaml
        isKind:
          of: ConfigMap
      - template: templates/server-dockerize-configmap.yaml
        hasDocuments:
          count: 0

  - it: mounts only sprig config volume when configMapsToMount is sprig
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "sprig"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: config-sprig
            configMap:
              name: RELEASE-NAME-temporal-sprig-config
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: config-dockerize

  # Test entrypoint command override
  - it: overrides command to use entrypoint script when useEntrypointScript is true
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/entrypoint/entrypoint.sh"]

  - it: does not override command when useEntrypointScript is false
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: false
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].command

  # Test entrypoint script volume mount
  - it: mounts entrypoint script volume when useEntrypointScript is true
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: entrypoint-script
            configMap:
              name: RELEASE-NAME-temporal-entrypoint-script
              defaultMode: 493 # 0755 in decimal
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: entrypoint-script
            mountPath: /entrypoint
            readOnly: true

  # Test config-processed emptyDir volume
  - it: creates config-processed emptyDir volume when useEntrypointScript is true
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: config-processed
            emptyDir: {}
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config-processed
            mountPath: /etc/temporal/config

  # Test backward compatibility (useEntrypointScript: false)
  - it: mounts config directly when useEntrypointScript is false with dockerize config
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: false
        configMapsToMount: "dockerize"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config-dockerize
            mountPath: /etc/temporal/config/config_template.yaml
            subPath: config_template.yaml

  - it: mounts config directly when useEntrypointScript is false with sprig config
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        useEntrypointScript: false
        configMapsToMount: "sprig"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config-sprig
            mountPath: /etc/temporal/config/config_template.yaml
            subPath: config_template.yaml

  # Test environment variables
  - it: does not set TEMPORAL_SERVER_CONFIG_FILE_PATH by default
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEMPORAL_SERVER_CONFIG_FILE_PATH

  - it: does not set TEMPORAL_SERVER_CONFIG_FILE_PATH when setConfigFilePath is false
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        setConfigFilePath: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEMPORAL_SERVER_CONFIG_FILE_PATH

  - it: sets TEMPORAL_SERVER_CONFIG_FILE_PATH when setConfigFilePath is true
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    set:
      server:
        enabled: true
        setConfigFilePath: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEMPORAL_SERVER_CONFIG_FILE_PATH
            value: /etc/temporal/config/config_template.yaml

  # Test entrypoint script content for auto-detection
  # Test entrypoint script content for auto-detection
  - it: entrypoint script contains dockerize detection logic for both configs
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "if command -v dockerize"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "Using dockerize config"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "Using sprig config"

  - it: entrypoint script uses dockerize config when configMapsToMount is dockerize
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "dockerize"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "Using dockerize config"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "dockerize"

  - it: entrypoint script uses sprig config when configMapsToMount is sprig
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "sprig"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "Using sprig config"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "TEMPORAL_SERVER_CONFIG_FILE_PATH"

  # Test entrypoint script command-line arguments and paths
  - it: entrypoint script uses correct temporal-server args for both/dockerize mode
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'temporal-server --root / --config etc/temporal/config --env docker start --service="\$\{TEMPORAL_SERVICES\}"'
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'SOURCE_CONFIG="/etc/temporal/config-source/dockerize/config_template.yaml"'
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'TARGET_CONFIG="/etc/temporal/config/docker.yaml"'
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'dockerize -template "\$\{SOURCE_CONFIG\}:\$\{TARGET_CONFIG\}"'

  - it: entrypoint script uses simple temporal-server start for sprig mode
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "sprig"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "exec temporal-server start$"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'export TEMPORAL_SERVER_CONFIG_FILE_PATH="/etc/temporal/config-source/sprig/config_template.yaml"'

  - it: entrypoint script uses correct args for dockerize-only mode
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "dockerize"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'temporal-server --root / --config etc/temporal/config --env docker start --service="\$\{TEMPORAL_SERVICES\}"'
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'dockerize -template "\$\{SOURCE_CONFIG\}:\$\{TARGET_CONFIG\}"'

  # Test error handling in entrypoint script
  - it: entrypoint script checks for dockerize when configMapsToMount is dockerize
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "dockerize"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "if ! command -v dockerize"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "ERROR: dockerize config requires dockerize but it was not found"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "Either install an image with dockerize or use configMapsToMount: sprig"
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "exit 1"

  - it: entrypoint script does not check for dockerize when configMapsToMount is both
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - notMatchRegex:
          path: data["entrypoint.sh"]
          pattern: "ERROR: dockerize config requires dockerize"

  - it: entrypoint script does not check for dockerize when configMapsToMount is sprig
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "sprig"
    asserts:
      - notMatchRegex:
          path: data["entrypoint.sh"]
          pattern: "ERROR: dockerize config requires dockerize"

  # Test entrypoint script uses TEMPORAL_SERVICES variable
  - it: entrypoint script references TEMPORAL_SERVICES environment variable
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: 'echo "Temporal entrypoint override - starting \$\{TEMPORAL_SERVICES\}"'
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: '--service="\$\{TEMPORAL_SERVICES\}"'

  # Test all services get the same configuration
  - it: applies entrypoint configuration to all server services
    template: templates/server-deployment.yaml
    set:
      server:
        enabled: true
        useEntrypointScript: true
        configMapsToMount: "both"
    asserts:
      - hasDocuments:
          count: 4 # frontend, history, matching, worker (internalFrontend is disabled by default)
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/entrypoint/entrypoint.sh"]
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/entrypoint/entrypoint.sh"]
        documentIndex: 1
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/entrypoint/entrypoint.sh"]
        documentIndex: 2
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/entrypoint/entrypoint.sh"]
        documentIndex: 3
