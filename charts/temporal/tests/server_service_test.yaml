suite: test server service
templates:
  - server-service.yaml
set:
  server:
    internalFrontend:
      enabled: true
    replicaCount: 2
    resources:
      requests:
        cpu: 100m
    frontend:
      replicaCount: 3
      resources:
        requests:
          cpu: 200m
tests:
  - it: omits prometheus annotations when disabled
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend-headless")].kind'
      value: Service
      matchMany: true
    set:
      server:
        frontend:
          metrics:
            annotations:
              enabled: false
    asserts:
      - notExists:
          path: metadata.annotations["prometheus.io/job"]
      - notExists:
          path: metadata.annotations["prometheus.io/scrape"]
      - notExists:
          path: metadata.annotations["prometheus.io/port"]
  - it: doesn't create any services when the server is disabled
    template: templates/server-service.yaml
    set:
      server:
        enabled: false
    asserts:
      - not: true
        containsDocument:
          kind: Service
          apiVersion: v1
  - it: app protocol default in frontend service
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 2
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7233
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: http
            name: http
            port: 7243
            protocol: TCP
            targetPort: http
  - it: app protocol default in internal frontend services
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-internal-frontend")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 2
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7236
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: http
            name: http
            port: 7246
            protocol: TCP
            targetPort: http
  - it: app protocol default in frontend service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend-headless")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7233
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tcp
            name: grpc-membership
            port: 6933
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol default in internal frontend service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-internal-frontend-headless")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7236
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tcp
            name: grpc-membership
            port: 6936
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol default in matching service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-matching-headless")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7235
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tcp
            name: grpc-membership
            port: 6935
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol default in history service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-history-headless")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7234
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tcp
            name: grpc-membership
            port: 6934
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol default in worker service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-worker-headless")].kind'
      value: Service
      matchMany: true
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: tcp
            name: grpc-rpc
            port: 7239
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tcp
            name: grpc-membership
            port: 6939
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol custom in frontend service
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Service
      matchMany: true
    set:
      server:
        frontend:
          service:
            appProtocol: grpc
            httpAppProtocol: http2
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 2
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7233
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: http2
            name: http
            port: 7243
            protocol: TCP
            targetPort: http
  - it: app protocol custom in internal frontend services
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-internal-frontend")].kind'
      value: Service
      matchMany: true
    set:
      server:
        internalFrontend:
          service:
            appProtocol: grpc
            httpAppProtocol: http2
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 2
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7236
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: http2
            name: http
            port: 7246
            protocol: TCP
            targetPort: http
  - it: app protocol custom in frontend service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend-headless")].kind'
      value: Service
      matchMany: true
    set:
      server:
        frontend:
          service:
            appProtocol: grpc
            membershipAppProtocol: tls
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7233
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tls
            name: grpc-membership
            port: 6933
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol custom in internal frontend service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-internal-frontend-headless")].kind'
      value: Service
      matchMany: true
    set:
      server:
        internalFrontend:
          service:
            appProtocol: grpc
            membershipAppProtocol: tls
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7236
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tls
            name: grpc-membership
            port: 6936
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol custom in matching service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-matching-headless")].kind'
      value: Service
      matchMany: true
    set:
      server:
        matching:
          service:
            appProtocol: grpc
            membershipAppProtocol: tls
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7235
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tls
            name: grpc-membership
            port: 6935
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol custom in history service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-history-headless")].kind'
      value: Service
      matchMany: true
    set:
      server:
        history:
          service:
            appProtocol: grpc
            membershipAppProtocol: tls
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7234
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tls
            name: grpc-membership
            port: 6934
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
  - it: app protocol custom in worker service headless
    template: templates/server-service.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-worker-headless")].kind'
      value: Service
      matchMany: true
    set:
      server:
        worker:
          service:
            appProtocol: grpc
            membershipAppProtocol: tls
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[0]
          value:
            appProtocol: grpc
            name: grpc-rpc
            port: 7239
            protocol: TCP
            targetPort: rpc
      - equal:
          path: spec.ports[1]
          value:
            appProtocol: tls
            name: grpc-membership
            port: 6939
            protocol: TCP
            targetPort: membership
      - equal:
          path: spec.ports[2]
          value:
            appProtocol: http
            name: metrics
            port: 9090
            protocol: TCP
            targetPort: metrics
