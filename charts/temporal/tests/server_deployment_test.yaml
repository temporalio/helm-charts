suite: test server deployment
templates:
  - server-deployment.yaml
  - server-configmap.yaml
set:
  server:
    enabled: true
    config:
      persistence:
        defaultStore: default
        visibilityStore: visibility
        datastores:
          default:
            sql:
              password: "secret"
          visibility:
            sql:
              password: "secret"
    replicaCount: 2
    resources:
      requests:
        cpu: 100m
    frontend:
      replicaCount: 3
      resources:
        requests:
          cpu: 200m
tests:
  - it: defaults to service wide replica count
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name != "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    asserts:
      - equal:
          path: spec.replicas
          value: 2
  - it: favours service specific replica count
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    asserts:
      - equal:
          path: spec.replicas
          value: 3
  - it: defaults to service wide resources
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name != "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
  - it: favours service specific resources
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-frontend
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 200m
  - it: includes additional init containers
    template: templates/server-deployment.yaml
    documentSelector:
      path: .kind
      value: Deployment
      matchMany: true
    set:
      server:
        additionalInitContainers:
          - name: my-init-container
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: my-init-container
  - it: omits prometheus annotations when disabled
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        frontend:
          metrics:
            annotations:
              enabled: false
    asserts:
      - notExists:
          path: spec.template.metadata.annotations["prometheus.io/job"]
      - notExists:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
      - notExists:
          path: spec.template.metadata.annotations["prometheus.io/port"]
  - it: minReadySeconds defaults to service wide resources
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        minReadySeconds: 10
    asserts:
      - equal:
          path: spec.template.spec.minReadySeconds
          value: 10
  - it: minReadySeconds favours service specific resources
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        minReadySeconds: 10
        frontend:
          minReadySeconds: 30
    asserts:
      - equal:
          path: spec.template.spec.minReadySeconds
          value: 30
  - it: renders log config with defaults
    template: templates/server-configmap.yaml
    asserts:
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: "stdout: true"
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: 'level: "debug,info"'
      - notMatchRegex:
          path: data["config_template.yaml"]
          pattern: "outputFile:"
      - notMatchRegex:
          path: data["config_template.yaml"]
          pattern: "format:"
  - it: renders log config with overrides
    template: templates/server-configmap.yaml
    set:
      server:
        config:
          logstdOut: false
          logLevel: warn
          logOutputFile: /var/log/temporal.log
          logFormat: json
    asserts:
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: "stdout: false"
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: 'level: "warn"'
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: 'outputFile: "/var/log/temporal.log"'
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: 'format: "json"'
  - it: deploymentStrategy defaults to service wide resources
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        deploymentStrategy:
          type: RollingUpdate
          rollingUpdate:
            maxSurge: 25%
            maxUnavailable: 25%
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 25%
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 25%
  - it: deploymentStrategy favours service specific resources
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        deploymentStrategy:
          type: Recreate
        frontend:
          deploymentStrategy:
            type: RollingUpdate
            rollingUpdate:
              maxSurge: 1
              maxUnavailable: 0
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0
  - it: readinessProbe defaults to empty
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-worker")].kind'
      value: Deployment
      matchMany: true
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].readinessProbe
  - it: readinessProbe is set for frontend service
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-frontend")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        frontend:
          readinessProbe:
            grpc:
              port: 9999
              service: WorkflowService
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.grpc.port
          value: 9999
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.grpc.service
          value: WorkflowService
  - it: readinessProbe is set for history service
    template: templates/server-deployment.yaml
    documentSelector:
      path: '$[?(@.metadata.name == "RELEASE-NAME-temporal-history")].kind'
      value: Deployment
      matchMany: true
    set:
      server:
        history:
          readinessProbe:
             initialDelaySeconds: 300
             tcpSocket:
               port: rpc
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 300
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.tcpSocket.port
          value: rpc
