suite: test init container tool checks
templates:
  - server-deployment.yaml
  - server-job.yaml
  - server-entrypoint-script.yaml
  - server-dockerize-configmap.yaml
  - server-sprig-configmap.yaml
  - server-dynamicconfigmap.yaml
  - _helpers.tpl
release:
  name: test-release
  namespace: default
set:
  cassandra:
    enabled: true
    config:
      cluster_size: 1
  elasticsearch:
    enabled: true
tests:
  # Test Cassandra init container uses cassandra image
  - it: should use cassandra image for cassandra init containers
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: test-release-temporal-frontend
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "check-cassandra")].image
          value: "cassandra:3.11.3"
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "check-cassandra-temporal-schema")].image
          value: "cassandra:3.11.3"

  # Test Cassandra init container uses cqlsh commands
  - it: should use cqlsh for cassandra checks
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: test-release-temporal-frontend
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-cassandra")].command[2]
          pattern: "cqlsh.*SHOW VERSION"
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-cassandra-temporal-schema")].command[2]
          pattern: "cqlsh.*SELECT keyspace_name FROM system_schema.keyspaces"

  # Test Elasticsearch init container checks temporal-elasticsearch-tool first
  - it: should check for temporal-elasticsearch-tool before curl in deployment
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: test-release-temporal-frontend
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-elasticsearch-index")].args[0]
          pattern: 'if \[ -x /usr/local/bin/temporal-elasticsearch-tool \][\s\S]*elif command -v curl'

  # Test Elasticsearch init container in job checks temporal-elasticsearch-tool first
  - it: should check for temporal-elasticsearch-tool before curl in job
    template: templates/server-job.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-elasticsearch")].args[0]
          pattern: 'if \[ -x /usr/local/bin/temporal-elasticsearch-tool \][\s\S]*elif command -v curl'

  # Test Elasticsearch init container error messages
  - it: should have proper error messages for elasticsearch checks
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: test-release-temporal-frontend
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-elasticsearch-index")].args[0]
          pattern: "ERROR: Neither temporal-elasticsearch-tool nor curl found"

  # Test Cassandra hosts without trailing comma
  - it: should not have trailing comma in cassandra hosts
    template: templates/server-dockerize-configmap.yaml
    asserts:
      - notMatchRegex:
          path: data["config_template.yaml"]
          pattern: 'hosts: ".*,"'
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: 'hosts: "test-release-cassandra\.default"'

  # Test entrypoint script has correct --root flag
  - it: should have correct temporal-server command with --root flag
    template: templates/server-entrypoint-script.yaml
    set:
      server:
        useEntrypointScript: true
    asserts:
      - matchRegex:
          path: data["entrypoint.sh"]
          pattern: "temporal-server --root / --config etc/temporal/config --env docker start"

  # Test that all four service deployments have cassandra init containers
  - it: should have cassandra init containers in all service deployments
    template: templates/server-deployment.yaml
    asserts:
      - hasDocuments:
          count: 4

  # Test that cassandra init containers use proper host helper
  - it: should use cassandra.host helper in init containers
    template: templates/server-deployment.yaml
    documentSelector:
      path: metadata.name
      value: test-release-temporal-frontend
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-cassandra")].command[2]
          pattern: 'test-release-cassandra\.default'
      - matchRegex:
          path: spec.template.spec.initContainers[?(@.name == "check-cassandra-temporal-schema")].command[2]
          pattern: 'test-release-cassandra\.default'

  # Test multi-node cassandra cluster hosts
  - it: should generate comma-separated hosts for multi-node cassandra without trailing comma
    set:
      cassandra:
        enabled: true
        config:
          cluster_size: 3
    template: templates/server-dockerize-configmap.yaml
    asserts:
      - matchRegex:
          path: data["config_template.yaml"]
          pattern: 'hosts: "test-release-cassandra\.default,test-release-cassandra\.default,test-release-cassandra\.default"'
      - notMatchRegex:
          path: data["config_template.yaml"]
          pattern: 'hosts: ".*,"$'
