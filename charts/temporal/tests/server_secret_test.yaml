suite: test server secret
templates:
  - server-secret.yaml
tests:
  - it: creates a secret for the default store
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  password: "test1"
              visibility:
                sql:
                  password: "test2"
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-default-store
    asserts:
      - equal:
          path: data.password
          value: "dGVzdDE="
  - it: creates a secret for the visibility store
    set:
      server:
        config:
          persistence:
            datastores:
              default:
                sql:
                  password: "test1"
              visibility:
                sql:
                  password: "test2"
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-temporal-visibility-store
    asserts:
      - equal:
          path: data.password
          value: "dGVzdDI="
  - it: creates a secret when the server job is enabled, even when server.enabled is false
    set:
      server:
        enabled: false
        config:
          persistence:
            datastores:
              default:
                sql:
                  password: "test"
              visibility:
                sql:
                  password: "test"
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
