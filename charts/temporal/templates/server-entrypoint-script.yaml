{{- if and .Values.server.enabled .Values.server.useEntrypointScript -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ include "temporal.fullname" $ }}-entrypoint-script"
  labels:
    {{- include "temporal.resourceLabels" (list $ "" "") | nindent 4 }}
data:
  entrypoint.sh: |-
    #!/bin/sh
    set -e

    echo "Temporal entrypoint override - starting ${TEMPORAL_SERVICES}"

    {{- if eq .Values.server.configMapsToMount "both" }}
    # Auto-detect config format based on dockerize availability
    if command -v dockerize >/dev/null 2>&1; then
      echo "Using dockerize config"
      SOURCE_CONFIG="/etc/temporal/config-source/dockerize/config_template.yaml"
      TARGET_CONFIG="/etc/temporal/config/docker.yaml"
      dockerize -template "${SOURCE_CONFIG}:${TARGET_CONFIG}"
      exec temporal-server --root / --config etc/temporal/config --env docker start --service="${TEMPORAL_SERVICES}"
    else
      echo "Using sprig config"
      export TEMPORAL_SERVER_CONFIG_FILE_PATH="/etc/temporal/config-source/sprig/config_template.yaml"
      exec temporal-server start
    fi
    {{- else if eq .Values.server.configMapsToMount "dockerize" }}
    if ! command -v dockerize >/dev/null 2>&1; then
      echo "ERROR: dockerize config requires dockerize but it was not found" >&2
      echo "Either install an image with dockerize or use configMapsToMount: sprig" >&2
      exit 1
    fi

    echo "Using dockerize config"
    SOURCE_CONFIG="/etc/temporal/config-source/dockerize/config_template.yaml"
    TARGET_CONFIG="/etc/temporal/config/docker.yaml"
    dockerize -template "${SOURCE_CONFIG}:${TARGET_CONFIG}"
    exec temporal-server --root / --config etc/temporal/config --env docker start --service="${TEMPORAL_SERVICES}"
    {{- else if eq .Values.server.configMapsToMount "sprig" }}
    echo "Using sprig config"
    export TEMPORAL_SERVER_CONFIG_FILE_PATH="/etc/temporal/config-source/sprig/config_template.yaml"
    exec temporal-server start
    {{- else }}
    echo "ERROR: Invalid configMapsToMount value: {{ .Values.server.configMapsToMount }}" >&2
    echo "Must be one of: both, dockerize, sprig" >&2
    exit 1
    {{- end }}
{{- end }}
